<?php

namespace suite6\LightCDN;

use Entities\AssetInfo;

class LightCDNEngine {

    private $client_request;
    private $allowed_servers;
    private $header;

    public function __construct($request) {
        global $settings;

        $this->client_request = $request;
        $this->allowed_servers = $settings['allowed servers'];
    }

    public function getBaseDataPath() {
        return 'data/';
    }

    public function getFileNameFromReferrer() {
        $ext = end(explode('.', $this->client_request->url));
        return md5($this->client_request->url) . '.' . $ext;
        //return md5($this->request->host) . '-' . md5($this->request->url);
    }

    public function getFilePathFromReferrer() {
        return $this->getBaseDataPath() . $this->getFileNameFromReferrer();
    }

    public function getFilePathFromURL() {
        return $this->getBaseDataPath() . $this->getFileNameFromReferrer();
    }

    // Check reguested server is valid or not
    public function isToAllowedServer() {
        return (in_array($this->client_request->host, $this->allowed_servers));
    }

    public function getAsset()
    {
        global $tackler_config;
         if (($this->client_request->isGET() OR $this->client_request->isHEAD()) AND $this->isToAllowedServer())
            return $this->getServeAsset();
        else
            header("Location: " . $tackler_config->get_default_403_handler());
    }


    public function getServeAsset() {
        global $entityManager,$tackler_config;
        
        if (file_exists($this->getFilePathFromReferrer())) {
            if ($this->validate())
                $this->serve();
            else
                header("Location: " . $tackler_config->get_default_404_handler());
        }
        else {
            if ($this->save())
                $this->serve();
            else
                header("Location: " . $tackler_config->get_default_404_handler());
        }
    }

    // Save asset or update
    public function save() {

        global $entityManager;
        $file_name = $this->getFilePathFromURL();
        if ((isset($this->client_request->headers['cache-control']) && $this->client_request->headers['cache-control'] != 'no-cache') || (isset($this->client_request->headers['pragma']) && $this->client_request->headers['pragma'] != 'no-cache')) {
            $return_data = array();
            $new_header = array();
            $ch = curl_init();
            curl_setopt($ch, CURLOPT_URL, $this->client_request->url);
            curl_setopt($ch, CURLOPT_HEADER, 1);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
            curl_setopt($ch, CURLOPT_BINARYTRANSFER, 1);
            $return = curl_exec($ch);
            $info = curl_getinfo($ch);
            curl_close($ch);
            list($curl_header, $asset) = explode("\r\n\r\n", $return, 2);


            if (isset($this->client_request->headers['expires']))
                $new_header['expires'] = $this->client_request->headers['expires'];

            if (isset($this->client_request->headers['content-type']))
                $new_header['content-type'] = $this->client_request->headers['content-type'];

            if (isset($this->client_request->headers['last-modified']))
                $new_header['last-modified'] = $this->client_request->headers['last-modified'];

            $new_header['content-length'] = $info['size_download'];

            if (isset($this->client_request->headers['etag']))
                $new_header['etag'] = $this->client_request->headers['etag'];

            $new_header['via'] = $_SERVER['HTTP_HOST'];

            if (isset($this->client_request->headers['vary']))
                $new_header['vary'] = $this->client_request->headers['vary'];

            if (isset($this->client_request->headers['accept-encoding']))
                $new_header['accept-encoding'] = $this->client_request->headers['accept-encoding'];

            if (isset($this->client_request->headers['content-language']))
                $new_header['content-language'] = $this->client_request->headers['content-language'];

            // check required space in data director if full remove data.
            if ($this->clean_up()) {
                // if file exist refresh
                if (file_exists($file_name))
                    @unlink($file_name);

                //Shahbaz: What happens if the write fails ??
                //Replied: If write fali return null  (redirect 404)
                if (file_put_contents($file_name, $asset)) {
                    $this->header = serialize($new_header);
                    if (preg_match('/expires/', $this->header) || preg_match('/etag/', $this->header)) {
                        $exist = false;
                        $exist = $entityManager->getRepository('Entities\AssetInfo')->findOneBy(array('original_url' => filter($this->client_request->url), 'deleted' => '0'));
                        if ($exist == false) {
                            $assets_info = new AssetInfo();
                            $assets_info->setHeader($this->header);
                            $assets_info->setLastServed(new \DateTime('NOW'));
                            $assets_info->setName(filter($this->getFileNameFromReferrer()));
                            $assets_info->setSize(filter($info['size_download']));
                            $assets_info->setOriginalUrl(filter($this->client_request->url));
                            $assets_info->setMimeType(filter($info['content_type']));
                            //save entity to db
                            $entityManager->persist($assets_info);
                            $entityManager->flush();
                        } else {
                            // iIf expiry date that is passed it refreshes the image from the server and updates the headers
                            $exist->setHeader($this->header);
                            $entityManager->flush();
                        }
                    }
                    return true;
                }
            }
        }
        return null;
    }

// Read the record from the database and return
    public function serve() {
        global $entityManager, $connection;

        $return = array();
        //update last served;
        $assets_info = $entityManager->getRepository('Entities\AssetInfo')->findOneBy(array('original_url' => filter($this->client_request->url)));
        $assets_info->setLastServed(new \DateTime('NOW'));
        $entityManager->flush();
        ignore_user_abort(false);

        $filename = $this->getFilePathFromURL();
        if (file_exists($filename)) {

            // Build header here, return header
            $headers = unserialize($assets_info->getHeader());
            header('Content-Type: ' . $assets_info->getMimeType());
            header('Content-Length: ' . $assets_info->getSize());
            
            if (isset($headers['via']))
                header('Via: ' . $_SERVER['HTTP_HOST']);

            if (isset($headers['vary']))
                header('Vary: ' . $headers['vary']);

            if (isset($headers['last-modified']))
                header('Last-Modified: ' . $headers['last-modified']);

            if (isset($headers['etag']))
                header('ETag: ' . $headers['etag']);

            if (isset($headers['content-language']))
                header('Content-Language: ' . $headers['content-language']);

            if (isset($headers['accept-encoding']))
                header('Accept-Encoding: ' . $headers['accept-encoding']);

            if (isset($headers['expires']))
                header('Expires: ' . $headers['expires']);

            if (($this->client_request->isGET()) && file_exists($filename))
                readfile($filename);
        }
    }

// Locate the record from the database by original URL and deleted = FALSE
    public function validate() {
        global $entityManager;

        $assets_info = $entityManager->getRepository('Entities\AssetInfo')->findOneBy(array('original_url' => filter($this->client_request->url), 'deleted' => '0'));
        $header = unserialize($assets_info->getHeader());
        //If expiry date that is passed it refreshes the image from the server and updates the headers
        if (isset($header['expires']) && strtotime($header['expires']) < time())
            $this->save($assets_info->getOriginalUrl(), $assets_info->getName());
        if ($assets_info)
            return $assets_info;
        else
            return null;
    }

// if memory exceeded remove asset(s) from data directory
    public function clean_up() {
        global $settings, $connection, $dir_path;         
        
        // For run cron pass 2 int arguments arguments  e.g (5,2)
        $func_num_args =  func_num_args();
        $where = "";
        $limit = "LIMIT 1";
//        if($func_num_args >0)
//        {   
//            $where = "AND mod(id,".func_get_arg(0).")=".func_get_arg(1)."" ;
//            $limit = "";
//        }
        //Total size in bytes
        $toatl_disk_size = disk_total_space("/");
        //For window
        //$toatl_disk_size = disk_total_space("H:");
        //Total size of data directory in bytes
        $total_size_data = ($toatl_disk_size * $settings['setting']['max space']) / 100;
        //if size downloded greater than total size return false
        //if($argument_count == 0)
        //
        // Total occupied size of data folder        
        $total_occupied = $this->getDirectorySize($dir_path);

        $total_occupied = $total_occupied;

            while ($total_occupied >= $total_size_data) {
                $assets_info = array();
                $assets_info = $connection->prepare("SELECT * FROM assets_info WHERE deleted = 0 $where ORDER BY last_served DESC $limit");
                $assets_info->execute();
                $results = $assets_info->fetchAll();
                
                if ($results) {
                    foreach ($results as $record)
                    {
                        $update = $connection->prepare("UPDATE  assets_info SET deleted = 1  WHERE id = " . $record['id'] . " ");
                        $update->execute();
                        @unlink($this->getBaseDataPath() . $record['file_name']);
                        $total_occupied = $total_occupied - $results[0]['file_size'];
                    }
                }
                
            }
        return true;
    }
    // get directory size
    public function getDirectorySize($directory) {
        $dirSize = 0;

        if (!$dh = opendir($directory))
            return false;

        while ($file = readdir($dh)) {
            if ($file == "." || $file == "..")
                continue;

            if (is_file($directory . "/" . $file))
                $dirSize += filesize($directory . "/" . $file);

            if (is_dir($directory . "/" . $file))
                $dirSize += $this->getDirectorySize($directory . "/" . $file);
        }

        closedir($dh);

        return $dirSize;
    }

}